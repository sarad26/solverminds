{"version":3,"sources":["../../src/ts/headerRendering/header/selectAllFeature.ts"],"names":[],"mappings":"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","file":"selectAllFeature.js","sourcesContent":["import { AgCheckbox } from \"../../widgets/agCheckbox\";\nimport { BeanStub } from \"../../context/beanStub\";\nimport { PostConstruct, Autowired } from \"../../context/context\";\nimport { ColumnApi } from \"../../columnController/columnApi\";\nimport { GridApi } from \"../../gridApi\";\nimport { Events } from \"../../events\";\nimport { IRowModel } from \"../../interfaces/iRowModel\";\nimport { Constants } from \"../../constants/constants\";\nimport { Column } from \"../../entities/column\";\nimport { RowNode } from \"../../entities/rowNode\";\nimport { SelectionController } from \"../../selectionController\";\nimport { getAriaDescribedBy, setAriaDescribedBy } from \"../../utils/aria\";\nimport { isVisible } from \"../../utils/dom\";\n\nexport class SelectAllFeature extends BeanStub {\n\n    @Autowired('gridApi') private gridApi: GridApi;\n    @Autowired('columnApi') private columnApi: ColumnApi;\n    @Autowired('rowModel') private rowModel: IRowModel;\n    @Autowired('selectionController') private selectionController: SelectionController;\n\n    private cbSelectAllVisible = false;\n    private processingEventFromCheckbox = false;\n    private column: Column;\n\n    private filteredOnly: boolean;\n    private cbSelectAll: AgCheckbox;\n\n    constructor(cbSelectAll: AgCheckbox, column: Column) {\n        super();\n        this.cbSelectAll = cbSelectAll;\n        this.column = column;\n\n        const colDef = column.getColDef();\n        this.filteredOnly = colDef ? !!colDef.headerCheckboxSelectionFilteredOnly : false;\n    }\n\n    @PostConstruct\n    private postConstruct(): void {\n        this.showOrHideSelectAll();\n\n        this.addManagedListener(this.eventService, Events.EVENT_NEW_COLUMNS_LOADED, this.showOrHideSelectAll.bind(this));\n        this.addManagedListener(this.eventService, Events.EVENT_DISPLAYED_COLUMNS_CHANGED, this.showOrHideSelectAll.bind(this));\n        this.addManagedListener(this.eventService, Events.EVENT_SELECTION_CHANGED, this.onSelectionChanged.bind(this));\n        this.addManagedListener(this.eventService, Events.EVENT_MODEL_UPDATED, this.onModelChanged.bind(this));\n        this.addManagedListener(this.cbSelectAll, AgCheckbox.EVENT_CHANGED, this.onCbSelectAll.bind(this));\n        this.cbSelectAll.getInputElement().setAttribute('tabindex', '-1');\n        this.refreshSelectAllLabel();\n    }\n\n    private showOrHideSelectAll(): void {\n        this.cbSelectAllVisible = this.isCheckboxSelection();\n        this.cbSelectAll.setDisplayed(this.cbSelectAllVisible);\n\n        if (this.cbSelectAllVisible) {\n            // in case user is trying this feature with the wrong model type\n            this.checkRightRowModelType();\n            // make sure checkbox is showing the right state\n            this.updateStateOfCheckbox();\n        }\n        this.refreshHeaderAriaDescribedBy(this.cbSelectAllVisible);\n    }\n\n    private refreshHeaderAriaDescribedBy(isSelectAllVisible: boolean): void {\n        const parentHeader = this.cbSelectAll.getParentComponent();\n        const parentHeaderGui = parentHeader && parentHeader.getGui();\n        if (!parentHeaderGui || !isVisible(parentHeaderGui)) { return; }\n\n        let describedByIds = '';\n\n        if (parentHeaderGui) {\n            describedByIds = getAriaDescribedBy(parentHeaderGui);\n        }\n\n        const cbSelectAllId = this.cbSelectAll.getInputElement().id;\n        const describedByIdsHasSelectAllFeature = describedByIds.indexOf(cbSelectAllId) !== -1;\n\n        if (isSelectAllVisible) {\n            if (!describedByIdsHasSelectAllFeature) {\n                setAriaDescribedBy(parentHeaderGui, `${cbSelectAllId} ${describedByIds.trim()}`);\n            }\n        } else if (describedByIdsHasSelectAllFeature) {\n            setAriaDescribedBy(parentHeaderGui, describedByIds.trim().split(' ').filter(id => id === cbSelectAllId).join(' '));\n        }\n    }\n\n    private onModelChanged(): void {\n        if (!this.cbSelectAllVisible) { return; }\n        this.updateStateOfCheckbox();\n    }\n\n    private onSelectionChanged(): void {\n        if (!this.cbSelectAllVisible) { return; }\n        this.updateStateOfCheckbox();\n    }\n\n    private getNextCheckboxState(selectionCount: SelectionCount): boolean | null {\n        // if no rows, always have it unselected\n        if (selectionCount.selected === 0 && selectionCount.notSelected === 0) {\n            return false;\n        }\n\n        // if mix of selected and unselected, this is the tri-state\n        if (selectionCount.selected > 0 && selectionCount.notSelected > 0) {\n            return null;\n        }\n\n        // only selected\n        if (selectionCount.selected > 0) {\n            return true;\n        }\n\n        // nothing selected\n        return false;\n    }\n\n    private updateStateOfCheckbox(): void {\n        if (this.processingEventFromCheckbox) { return; }\n\n        this.processingEventFromCheckbox = true;\n\n        const selectionCount = this.getSelectionCount();\n        const allSelected = this.getNextCheckboxState(selectionCount);\n\n        this.cbSelectAll.setValue(allSelected!);\n        this.refreshSelectAllLabel();\n\n        this.processingEventFromCheckbox = false;\n    }\n\n    private refreshSelectAllLabel(): void {\n        const translate = this.gridOptionsWrapper.getLocaleTextFunc();\n        const checked = this.cbSelectAll.getValue();\n        const ariaStatus = checked ? translate('ariaChecked', 'checked') : translate('ariaUnchecked', 'unchecked');\n        const ariaLabel = translate('ariaRowSelectAll', 'Press Space to toggle all rows selection');\n\n        this.cbSelectAll.setInputAriaLabel(`${ariaLabel} (${ariaStatus})`);\n    }\n\n    private getSelectionCount(): SelectionCount {\n        let selectedCount = 0;\n        let notSelectedCount = 0;\n\n        const callback = (node: RowNode) => {\n\n            if (this.gridOptionsWrapper.isGroupSelectsChildren() && node.group) { return; }\n\n            if (node.isSelected()) {\n                selectedCount++;\n            } else if (!node.selectable) {\n                // don't count non-selectable nodes!\n            } else {\n                notSelectedCount++;\n            }\n        };\n\n        if (this.filteredOnly) {\n            this.gridApi.forEachNodeAfterFilter(callback);\n        } else {\n            this.gridApi.forEachNode(callback);\n        }\n\n        return {\n            notSelected: notSelectedCount,\n            selected: selectedCount\n        };\n    }\n\n    private checkRightRowModelType(): void {\n        const rowModelType = this.rowModel.getType();\n        const rowModelMatches = rowModelType === Constants.ROW_MODEL_TYPE_CLIENT_SIDE;\n\n        if (!rowModelMatches) {\n            console.warn(`AG Grid: selectAllCheckbox is only available if using normal row model, you are using ${rowModelType}`);\n        }\n    }\n\n    private onCbSelectAll(): void {\n        if (this.processingEventFromCheckbox) { return; }\n        if (!this.cbSelectAllVisible) { return; }\n\n        const value = this.cbSelectAll.getValue();\n\n        if (value) {\n            this.selectionController.selectAllRowNodes(this.filteredOnly);\n        } else {\n            this.selectionController.deselectAllRowNodes(this.filteredOnly);\n        }\n    }\n\n    private isCheckboxSelection(): boolean {\n        let result = this.column.getColDef().headerCheckboxSelection;\n\n        if (typeof result === 'function') {\n            const func = result as (params: any) => boolean;\n            result = func({\n                column: this.column,\n                colDef: this.column.getColDef(),\n                columnApi: this.columnApi,\n                api: this.gridApi\n            });\n        }\n\n        if (result) {\n            if (this.gridOptionsWrapper.isRowModelServerSide()) {\n                console.warn('headerCheckboxSelection is not supported for Server Side Row Model');\n                return false;\n            }\n            if (this.gridOptionsWrapper.isRowModelInfinite()) {\n                console.warn('headerCheckboxSelection is not supported for Infinite Row Model');\n                return false;\n            }\n            if (this.gridOptionsWrapper.isRowModelViewport()) {\n                console.warn('headerCheckboxSelection is not supported for Viewport Row Model');\n                return false;\n            }\n            // otherwise the row model is compatible, so return true\n            return true;\n        }\n\n        return false;\n    }\n\n}\n\ninterface SelectionCount {\n    selected: number;\n    notSelected: number;\n}\n"]}